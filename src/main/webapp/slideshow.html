<!doctype html>
<html class="no-js" lang="en" dir="ltr">
<head>
    <!--<base href="./" />-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>slidy</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#000000">
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="manifest" href="manifest.webapp" />
    <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/benbarnett/jQuery-Animate-Enhanced@1.2.0/scripts/src/jquery.animate-enhanced.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/superslides/0.6.2/jquery.superslides.js"></script>

    <!--<script>window.jQuery || document.write('<script src="js/vendor/jquery-3.2.1.min.js"><\/script>')</script>-->

    <style>
        /*.constrained-container {*/
            /*max-width: 1000px;*/
            /*height: 500px;*/
            /*margin: 0 auto;*/
        /*}*/
    </style>
    <script>
        // this global date is appended to the request to tell the server the last time request was made.
        // the server then decides if to return resources or (not-modified).
        // initialized to EPOCH
        window.lastCheck = new Date(null);

        window.aleadyStarted = false;

        // this tells how many elements are presented, and server decides if to return resources if some slides were
        // deleted
        window.totalElements = 0;

        // The intervals (in milliseconds) on how often to execute the fetch
        window.SERVER_PING_INTERVAL = 10000;

        // Read a page's GET URL variables and return them as an associative array.
        function getUrlVars() {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for(var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }


        function fetchUserImages(callback) {
            var userlogin = getUrlVars()['user'];
            if (userlogin.indexOf('#') > -1) {
                userlogin = userlogin.substr(0, userlogin.indexOf('#'));
            }
            lastCheckAsIsoString = lastCheck.toISOString();
            var  url = encodeURI('/slideshow/get?user=' + userlogin + '&lastCheck=' + lastCheckAsIsoString + '&count=' + totalElements);
            $.get(url, function (data) {
                console.log(data);
                callback(data);
            })
        }

        // /**
        //  * creates an img element
        //  * @param src
        //  * @param alt
        //  * @param title
        //  * @returns {any}
        //  */
        // function img_create(src, alt, title) {
        //     var img = $('<img />');
        //     img.src = src;
        //     if ( alt != null ) img.alt = alt;
        //     if ( title != null ) img.title = title;
        //     return img;
        // }

        function img_create(item) {
            var x = document.createElement("IMG");
            x.setAttribute("src", 'data:' + item.dataContentType + ';base64,' + item.data);
            x.setAttribute("height", "100%");
            x.setAttribute("width", "100%");
            x.setAttribute("id", item.id);
            x.setAttribute("alt", item.name);
            x.setAttribute("title", item.title);
            x.setAttribute("showStartDate", item.showStartDate);
            x.setAttribute("showEndDate", item.showEndDate);
            x.classList.add("preserve");
            return x;
        }

        function startSlides() {

            $('#slides').superslides({
                hashchange: false,
                play: 5000
            });
            window.aleadyStarted = true;
            // $('#slides').on('mouseenter', function () {
            //     $(this).superslides('stop');
            //     console.log('Stopped')
            // });
            // $('#slides').on('mouseleave', function () {
            //     $(this).superslides('start');
            //     console.log('Started')
            // });


        }


        function updateTotalCount(data) {
            if (data && data.length > 0) {
                window.totalElements = data.length;
            }
        }

        function updateLastCheckTimestamp(data) {
            if (data && data.length > 0) {
                data.forEach(function (item) {
                    var lastModifiedDate = new Date(item.lastModifiedDate);
                    window.lastCheck = lastModifiedDate > window.lastCheck ? lastModifiedDate : window.lastCheck;
                });
            }
        }

        function imgExists(imgElements, id) {
            return imgElements.some(function(el) {
                return el.getAttribute("id") === id;
            });
        }

        function deleteImagesFromLocalStorage() {
            var arr = []; // Array to hold the keys
            for (var i = 0; i < localStorage.length; i++){
                if (localStorage.key(i).startsWith("img_")) {
                    arr.push(localStorage.key(i));
                }
            }
            for (i = 0; i < arr.length; i++) {
                localStorage.removeItem(arr[i]);
            }
        }
        function saveToLocalStorage(imgElements) {
            if (imgElements && imgElements.length > 0) {
                // if we received new content, then something changed.
                // so we need to renew the localStorage.
                deleteImagesFromLocalStorage();
                imgElements.forEach(function (img) {
                    localStorage.setItem("img_" + img.id, JSON.stringify(img));
                })
            }
        }

        function updateView() {
            $(".slides-container").empty();
            for (i = 0; i < window.localStorage.length; i++) {
                key = window.localStorage.key(i);
                if (key.startsWith("img_")) {
                    var slideItem = JSON.parse(localStorage.getItem(key));
                    var startDate = new Date(slideItem.showStartDate);
                    var endDate = new Date(slideItem.showEndDate);
                    var now = new Date();
                    if (startDate < now && now < endDate) {
                        var li = $('<li></li>');
                        var imgElement = img_create(slideItem);
                        var nameDiv = $('<div class="container"></div>').append(slideItem.name);
                        li.append(imgElement);
                        li.append(nameDiv);
                        $(".slides-container").append(li);
                    } else {
                        console.warn("image not displaying because of date range: ["+startDate + " - "+ endDate + "]");
                    }
                }
            }
            if (!window.aleadyStarted) {
                startSlides();
            } else {
                $("#slides").superslides('update');
            }
        }
        function afterFetch(data) {
            updateTotalCount(data);
            updateLastCheckTimestamp(data);
            saveToLocalStorage(data);
            updateView();
        }



        function refreshContent() {
            fetchUserImages(afterFetch);
        }

        function start() {
            fetchUserImages(afterFetch);
        }
        $(function() {
            start();
            var repeatingTask = window.setInterval(start, window.SERVER_PING_INTERVAL);
            console.log(repeatingTask);
        });
    </script>
</head>
<body>

        <div id="slides">
            <!--<button id="refreshContent" onclick="refreshContent()">refreshContent</button>-->
            <ul class="slides-container"></ul>

            <nav class="slides-navigation">
                <a href="#" class="next">Next</a>
                <a href="#" class="prev">Previous</a>
            </nav>
        </div>

</body>
</html>
